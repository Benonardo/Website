<!DOCTYPE html>
<html>
    <head>   
        <title>TomatenKuchen</title>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="shortcut icon" type="image/x-icon" href="icon.ico" />
    </head>
    <body>
        <nav>
            <ul>
                <li><a href="/">Startseite</a></li>
                <li><a tabindex="0" aria-current="page">Einstellungen</a></li>
            </ul>
        </nav>
        <img src="" id="profile_image">
        <p id="info" style="display: none;"></p>
        <p id="userid" style="display: none;"></p>
        <button id="logout" style="display: none;" onclick="logout()">Abmelden</button>
        <input id="msg" style="display: none;" value="Aktion"/>
        <button id="send" style="display: none;" onclick="send()">Speichern</button>
        <select id="guilds" style="display: none;" />
        <p id="guilderr" style="display: none;">Du bist auf keinem Server Besitzer oder hast Administratorrechte!</p>

        <script>
            function getCookie(cname) {
                var name = cname + "="
                var decodedCookie = decodeURIComponent(document.cookie)
                var ca = decodedCookie.split(';')
                for (var i = 0; i <ca.length; i++) {
                    var c = ca[i]
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1)
                    }
                    if (c.indexOf(name) == 0) return c.substring(name.length, c.length)
                }
                return ""
            }

            window.onload = () => {
                const fragment = new URLSearchParams(window.location.hash.slice(1))
    
                if (fragment.has("access_token")) {
                    const accessToken = fragment.get("access_token")
                    const tokenType = fragment.get("token_type")
                    console.log(accessToken + " | " + tokenType + " | " + fragment)
                    document.getElementById('logout').style.display = 'block'
                    document.getElementById('info').style.display = 'block'
                    document.getElementById('send').style.display = 'block'
                    document.getElementById('msg').style.display = 'block'
    
                    var xhr = new XMLHttpRequest()
                    xhr.open("GET", "https://discordapp.com/api/users/@me/guilds")
                    xhr.setRequestHeader("Content-Type", "application/json")
                    xhr.setRequestHeader("Authorization", tokenType + " " + accessToken)
                    xhr.onload = function() {
                        var response = JSON.parse(xhr.response)
                        if (!response) return window.location.replace("http://136.243.92.96:7025/")
        
                        response.forEach(guild => {
                            if (guild.owner || guild.permissions == "8") {
                                var selecter = document.createElement("option")
                                selecter.innerHTML = guild.name
                                selecter.value = guild.id
                                document.getElementById("guilds").appendChild(selecter)
                            }
                        })
                        if (document.getElementById("guilds").value == "") {
                            document.getElementById('guilds').style.display = 'none'
                            document.getElementById('guilderr').style.display = 'block'
                        } else {
                            document.getElementById('guilds').style.display = 'block'
                            document.getElementById('guilderr').style.display = 'none'
                        }
                        console.log(response)
                    }
                    xhr.send()
    
                    fetch('https://discordapp.com/api/users/@me', {
                        headers: {
                            authorization: `${tokenType} ${accessToken}`
                        }
                    })
                        .then(res => res.json())
                        .then(response => {
                            const {username, discriminator, id, avatar} = response
                            document.getElementById("info").innerText = username + "#" + discriminator
                            document.getElementById("userid").innerText = id
                            var profile_url = "https://cdn.discordapp.com/avatars/" + id + "/" + avatar + ".png?size=256"
                            document.getElementById('profile_image').src = profile_url
                        })
                } else {
                    window.location.replace("https://discord.com/api/oauth2/authorize?client_id=685166801394335819&redirect_uri=http%3A%2F%2F136.243.92.96%3A7025%2Fsettings&response_type=token&scope=identify%20guilds")
                }
            }
            logout = () => {
                window.location.replace("http://136.243.92.96:7025/")
            }
            send = () => {
                window.location.replace("http://136.243.92.96:7025/msg/" + document.getElementById("userid").innerText + "/" + document.getElementById("msg").value)
            }
        </script>
    </body>
</html>
